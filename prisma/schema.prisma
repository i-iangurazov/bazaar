generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  STAFF
  CASHIER
}

enum ThemePreference {
  LIGHT
  DARK
}

enum LegalEntityType {
  IP
  OSOO
  AO
  OTHER
}

enum StockMovementType {
  RECEIVE
  SALE
  RETURN
  ADJUSTMENT
  TRANSFER_IN
  TRANSFER_OUT
}

enum PurchaseOrderStatus {
  DRAFT
  SUBMITTED
  APPROVED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

enum CustomerOrderStatus {
  DRAFT
  CONFIRMED
  READY
  COMPLETED
  CANCELED
}

enum RegisterShiftStatus {
  OPEN
  CLOSED
}

enum PosPaymentMethod {
  CASH
  CARD
  TRANSFER
  OTHER
}

enum CashDrawerMovementType {
  PAY_IN
  PAY_OUT
}

enum PosReturnStatus {
  DRAFT
  COMPLETED
  CANCELED
}

enum PosKkmStatus {
  NOT_SENT
  SENT
  FAILED
}

enum StockCountStatus {
  DRAFT
  IN_PROGRESS
  APPLIED
  CANCELLED
}

enum AttributeType {
  TEXT
  NUMBER
  SELECT
  MULTI_SELECT
}

enum OrganizationPlan {
  STARTER
  BUSINESS
  ENTERPRISE
}

enum OrganizationSubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
}

enum PlanUpgradeRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AuthTokenType {
  EMAIL_VERIFY
  PASSWORD_RESET
  REGISTRATION
}

enum KkmMode {
  OFF
  EXPORT_ONLY
  CONNECTOR
  ADAPTER
}

enum MarkingMode {
  OFF
  OPTIONAL
  REQUIRED_ON_SALE
}

enum FiscalReceiptStatus {
  QUEUED
  PROCESSING
  SENT
  FAILED
}

enum RefundRequestStatus {
  OPEN
  RESOLVED
  CANCELED
}

enum MarkingCodeStatus {
  CAPTURED
  VOIDED
}

enum TaxReferenceDocumentType {
  PURCHASE
  TRANSFER
  SALE
}

enum ExportJobStatus {
  QUEUED
  RUNNING
  DONE
  FAILED
}

enum ExportType {
  INVENTORY_MOVEMENTS_LEDGER
  INVENTORY_BALANCES_AT_DATE
  PURCHASES_RECEIPTS
  PRICE_LIST
  SALES_SUMMARY
  STOCK_MOVEMENTS
  PURCHASES
  INVENTORY_ON_HAND
  PERIOD_CLOSE_REPORT
  RECEIPTS_FOR_KKM
  RECEIPTS_REGISTRY
  SHIFT_X_REPORT
  SHIFT_Z_REPORT
  SALES_BY_DAY
  SALES_BY_ITEM
  RETURNS_BY_DAY
  RETURNS_BY_ITEM
  CASH_DRAWER_MOVEMENTS
  MARKING_SALES_REGISTRY
  ETTN_REFERENCES
  ESF_REFERENCES
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  plan      OrganizationPlan @default(STARTER)
  subscriptionStatus OrganizationSubscriptionStatus @default(ACTIVE)
  trialEndsAt DateTime?
  currentPeriodEndsAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users           User[]
  stores          Store[]
  suppliers       Supplier[]
  products        Product[]
  units           Unit[]
  productCategories ProductCategory[]
  productBarcodes ProductBarcode[]
  productImages   ProductImage[]
  productPacks    ProductPack[]
  purchaseOrders  PurchaseOrder[]
  customerOrders  CustomerOrder[]
  auditLogs       AuditLog[]
  importBatches   ImportBatch[]
  stockCounts     StockCount[]
  storePrices     StorePrice[]
  productCosts    ProductCost[]
  productBundleComponents ProductBundleComponent[]
  stockLots       StockLot[]
  attributeDefinitions AttributeDefinition[]
  categoryTemplates CategoryAttributeTemplate[]
  variantAttributeValues VariantAttributeValue[]
  onboardingProgress OnboardingProgress?
  productEvents   ProductEvent[]
  deadLetterJobs  DeadLetterJob[]
  impersonationSessions ImpersonationSession[]
  inviteTokens    InviteToken[]
  accessRequests  AccessRequest[]
  complianceProfiles StoreComplianceProfile[]
  productComplianceFlags ProductComplianceFlags[]
  exportJobs ExportJob[]
  periodCloses PeriodClose[]
  diagnosticsReports DiagnosticsReport[]
  planUpgradeRequests PlanUpgradeRequest[]
  counters OrganizationCounter?
  posRegisters PosRegister[]
  registerShifts RegisterShift[]
  salePayments SalePayment[]
  cashDrawerMovements CashDrawerMovement[]
  saleReturns SaleReturn[]
  fiscalReceipts FiscalReceipt[]
  kkmConnectorDevices KkmConnectorDevice[]
  kkmConnectorPairingCodes KkmConnectorPairingCode[]
  refundRequests RefundRequest[]
  markingCodeCaptures MarkingCodeCapture[]
  ettnReferences EttnReference[]
  esfReferences EsfReference[]
}

model User {
  id           String   @id @default(cuid())
  organizationId String?
  email        String   @unique
  name         String
  phone        String?
  jobTitle     String?
  passwordHash String
  role         Role
  isOrgOwner   Boolean  @default(false)
  preferredLocale String @default("ru")
  themePreference ThemePreference @default(LIGHT)
  isActive     Boolean  @default(true)
  emailVerifiedAt DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id])
  auditLogs    AuditLog[]
  idempotencyKeys IdempotencyKey[]
  purchaseOrdersCreated PurchaseOrder[] @relation("purchaseOrdersCreated")
  purchaseOrdersUpdated PurchaseOrder[] @relation("purchaseOrdersUpdated")
  customerOrdersCreated CustomerOrder[] @relation("customerOrdersCreated")
  customerOrdersUpdated CustomerOrder[] @relation("customerOrdersUpdated")
  stockCountsCreated StockCount[] @relation("stockCountCreatedBy")
  stockCountsApplied StockCount[] @relation("stockCountAppliedBy")
  storePricesUpdated StorePrice[] @relation("storePricesUpdated")
  stockMovements StockMovement[]
  importBatchesCreated ImportBatch[] @relation("importBatchesCreated")
  importBatchesRolledBack ImportBatch[] @relation("importBatchesRolledBack")
  importRollbackReportsCreated ImportRollbackReport[] @relation("importRollbackReportsCreated")
  impersonationSessionsCreated ImpersonationSession[] @relation("impersonationsCreated")
  impersonationSessionsTargeted ImpersonationSession[] @relation("impersonationsTargeted")
  deadLetterJobsResolved DeadLetterJob[] @relation("deadLetterResolvedBy")
  productEventsCreated ProductEvent[] @relation("productEventsCreatedBy")
  storeFeatureFlagsUpdated StoreFeatureFlag[]
  inviteTokensCreated InviteToken[] @relation("inviteCreatedBy")
  authTokens AuthToken[]
  complianceProfilesUpdated StoreComplianceProfile[] @relation("complianceUpdatedBy")
  exportJobsRequested ExportJob[] @relation("exportRequestedBy")
  periodClosesCreated PeriodClose[] @relation("periodClosedBy")
  diagnosticsReportsCreated DiagnosticsReport[] @relation("diagnosticsCreatedBy")
  planUpgradeRequestsCreated PlanUpgradeRequest[] @relation("planUpgradeRequestedBy")
  planUpgradeRequestsReviewed PlanUpgradeRequest[] @relation("planUpgradeReviewedBy")
  registerShiftsOpened RegisterShift[] @relation("posShiftsOpened")
  registerShiftsClosed RegisterShift[] @relation("posShiftsClosed")
  salePaymentsCreated SalePayment[] @relation("salePaymentsCreated")
  cashDrawerMovementsCreated CashDrawerMovement[] @relation("cashDrawerMovementsCreated")
  saleReturnsCreated SaleReturn[] @relation("saleReturnsCreated")
  saleReturnsCompleted SaleReturn[] @relation("saleReturnsCompleted")
  kkmPairingCodesCreated KkmConnectorPairingCode[] @relation("kkmPairingCodeCreatedBy")
  refundRequestsCreated RefundRequest[] @relation("refundRequestsCreatedBy")
  refundRequestsReviewed RefundRequest[] @relation("refundRequestsReviewedBy")
  markingCodeCaptures MarkingCodeCapture[] @relation("markingCapturedBy")
  ettnReferencesCreated EttnReference[] @relation("ettnReferenceCreatedBy")
  esfReferencesCreated EsfReference[] @relation("esfReferenceCreatedBy")
  guideState UserGuideState?
}

model OrganizationCounter {
  organizationId    String  @id
  salesOrderNumber  Int     @default(0)
  posSaleNumber     Int     @default(0)
  posReturnNumber   Int     @default(0)
  updatedAt         DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model UserGuideState {
  id                 String   @id @default(cuid())
  userId             String   @unique
  completedToursJson Json
  dismissedTipsJson  Json
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([updatedAt])
}

model Store {
  id                String   @id @default(cuid())
  organizationId    String
  name              String
  code              String
  allowNegativeStock Boolean @default(false)
  trackExpiryLots   Boolean @default(false)
  legalEntityType   LegalEntityType?
  legalName         String?
  inn               String?
  address           String?
  phone             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  inventorySnapshots InventorySnapshot[]
  stockMovements StockMovement[]
  reorderPolicies ReorderPolicy[]
  forecastSnapshots ForecastSnapshot[]
  purchaseOrders PurchaseOrder[]
  customerOrders CustomerOrder[]
  stockCounts   StockCount[]
  stockCountLines StockCountLine[]
  stockLots     StockLot[]
  storePrices   StorePrice[]
  featureFlags StoreFeatureFlag[]
  complianceProfile StoreComplianceProfile?
  exportJobs ExportJob[]
  periodCloses PeriodClose[]
  posRegisters PosRegister[]
  registerShifts RegisterShift[]
  salePayments SalePayment[]
  cashDrawerMovements CashDrawerMovement[]
  saleReturns SaleReturn[]
  fiscalReceipts FiscalReceipt[]
  kkmConnectorDevices KkmConnectorDevice[]
  kkmConnectorPairingCodes KkmConnectorPairingCode[]
  refundRequests RefundRequest[]
  markingCodeCaptures MarkingCodeCapture[]
  ettnReferences EttnReference[]
  esfReferences EsfReference[]

  @@unique([organizationId, code])
  @@index([organizationId])
}

model StoreComplianceProfile {
  id             String   @id @default(cuid())
  organizationId String
  storeId        String   @unique
  defaultLocale  String?
  taxRegime      String?
  enableKkm      Boolean  @default(false)
  kkmMode        KkmMode  @default(OFF)
  enableEsf      Boolean  @default(false)
  enableEttn     Boolean  @default(false)
  enableMarking  Boolean  @default(false)
  markingMode    MarkingMode @default(OFF)
  kkmProviderKey String?
  kkmSettings    Json?
  updatedById    String?
  updatedAt      DateTime @updatedAt
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  updatedBy    User? @relation("complianceUpdatedBy", fields: [updatedById], references: [id])

  @@index([organizationId, storeId])
}

model ProductComplianceFlags {
  id             String   @id @default(cuid())
  organizationId String
  productId      String   @unique
  requiresMarking Boolean @default(false)
  requiresEttn    Boolean @default(false)
  markingType     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  product      Product @relation(fields: [productId], references: [id])

  @@index([organizationId, productId])
}

model ExportJob {
  id             String   @id @default(cuid())
  organizationId String
  storeId        String
  type           ExportType
  status         ExportJobStatus @default(QUEUED)
  periodStart    DateTime
  periodEnd      DateTime
  requestedById  String
  createdAt      DateTime @default(now())
  startedAt      DateTime?
  finishedAt     DateTime?
  fileName       String?
  mimeType       String?
  fileSize       Int?
  storagePath    String?
  paramsJson     Json?
  errorMessage   String?
  errorJson      Json?

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  requestedBy  User @relation("exportRequestedBy", fields: [requestedById], references: [id])

  @@index([organizationId, storeId, createdAt])
  @@index([status, createdAt])
}

model PeriodClose {
  id             String   @id @default(cuid())
  organizationId String
  storeId        String
  periodStart    DateTime
  periodEnd      DateTime
  closedAt       DateTime @default(now())
  closedById     String
  snapshotHash   String?
  totals         Json?

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  closedBy     User @relation("periodClosedBy", fields: [closedById], references: [id])

  @@unique([organizationId, storeId, periodStart, periodEnd])
  @@index([organizationId, storeId, closedAt])
}

model DiagnosticsReport {
  id             String   @id @default(cuid())
  organizationId String
  createdById    String
  createdAt      DateTime @default(now())
  resultsJson    Json

  organization Organization @relation(fields: [organizationId], references: [id])
  createdBy    User @relation("diagnosticsCreatedBy", fields: [createdById], references: [id])

  @@index([organizationId, createdAt])
  @@index([createdById, createdAt])
}

model PlanUpgradeRequest {
  id             String   @id @default(cuid())
  organizationId String
  requestedById  String
  currentPlan    OrganizationPlan
  requestedPlan  OrganizationPlan
  status         PlanUpgradeRequestStatus @default(PENDING)
  message        String? @db.Text
  reviewNote     String? @db.Text
  createdAt      DateTime @default(now())
  reviewedAt     DateTime?
  reviewedById   String?

  organization Organization @relation(fields: [organizationId], references: [id])
  requestedBy  User @relation("planUpgradeRequestedBy", fields: [requestedById], references: [id])
  reviewedBy   User? @relation("planUpgradeReviewedBy", fields: [reviewedById], references: [id])

  @@index([organizationId, status, createdAt])
  @@index([status, createdAt])
  @@index([requestedById, createdAt])
}

model Supplier {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  email          String?
  phone          String?
  notes          String? @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  products     Product[]
  purchaseOrders PurchaseOrder[]

  @@index([organizationId])
}

model Unit {
  id             String   @id @default(cuid())
  organizationId String
  code           String
  labelRu        String
  labelKg        String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  products      Product[]

  @@unique([organizationId, code])
  @@index([organizationId])
}

model ProductCategory {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, name])
  @@index([organizationId])
}

model Product {
  id             String   @id @default(cuid())
  organizationId String
  supplierId     String?
  sku            String
  name           String
  category       String?
  unit           String
  baseUnitId     String
  basePriceKgs   Decimal? @db.Decimal(12, 2)
  description    String? @db.Text
  photoUrl       String?
  isDeleted      Boolean  @default(false)
  isBundle       Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  supplier     Supplier? @relation(fields: [supplierId], references: [id])
  baseUnit     Unit @relation(fields: [baseUnitId], references: [id])
  barcodes     ProductBarcode[]
  packs        ProductPack[]
  variants     ProductVariant[]
  inventorySnapshots InventorySnapshot[]
  stockMovements StockMovement[]
  reorderPolicies ReorderPolicy[]
  forecastSnapshots ForecastSnapshot[]
  purchaseOrderLines PurchaseOrderLine[]
  bundleComponents ProductBundleComponent[] @relation("bundleComponents")
  bundleParents    ProductBundleComponent[] @relation("bundleParents")
  stockCounts      StockCountLine[]
  stockLots        StockLot[]
  storePrices      StorePrice[]
  productCosts     ProductCost[]
  attributeValues  VariantAttributeValue[]
  images           ProductImage[]
  complianceFlags  ProductComplianceFlags?
  customerOrderLines CustomerOrderLine[]
  saleReturnLines  SaleReturnLine[]

  @@unique([organizationId, sku])
  @@index([organizationId])
  @@index([organizationId, isDeleted, name])
  @@index([organizationId, category, isDeleted])
}

model ProductImage {
  id             String   @id @default(cuid())
  organizationId String
  productId      String
  url            String
  position       Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  product      Product @relation(fields: [productId], references: [id])

  @@index([organizationId])
  @@index([productId, position])
}

model ProductBarcode {
  id             String   @id @default(cuid())
  organizationId String
  productId      String
  value          String
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  product       Product @relation(fields: [productId], references: [id])

  @@unique([organizationId, value])
  @@index([productId])
  @@index([organizationId])
}

model ProductPack {
  id                String   @id @default(cuid())
  organizationId    String
  productId         String
  packName          String
  packBarcode       String?
  multiplierToBase  Int
  allowInPurchasing Boolean @default(true)
  allowInReceiving  Boolean @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  product      Product @relation(fields: [productId], references: [id])

  @@unique([productId, packName])
  @@unique([organizationId, packBarcode])
  @@index([organizationId])
  @@index([productId])
}

model ProductVariant {
  id        String   @id @default(cuid())
  productId String
  name      String?
  sku       String?
  attributes Json
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id])
  inventorySnapshots InventorySnapshot[]
  stockMovements StockMovement[]
  purchaseOrderLines PurchaseOrderLine[]
  stockCounts StockCountLine[]
  stockLots   StockLot[]
  storePrices StorePrice[]
  productCosts ProductCost[]
  attributeValues VariantAttributeValue[]
  bundleComponents ProductBundleComponent[] @relation("bundleComponentVariants")
  customerOrderLines CustomerOrderLine[]
  saleReturnLines  SaleReturnLine[]

  @@index([productId])
  @@index([sku])
}

model InventorySnapshot {
  id                String   @id @default(cuid())
  storeId           String
  productId         String
  variantId         String?
  variantKey        String   @default("BASE")
  onHand            Int
  onOrder           Int      @default(0)
  allowNegativeStock Boolean @default(false)
  updatedAt         DateTime @updatedAt

  store   Store   @relation(fields: [storeId], references: [id])
  product Product @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([storeId, productId, variantKey])
  @@index([storeId, productId, variantKey])
  @@index([storeId, updatedAt])
  @@index([updatedAt])
}

model StockMovement {
  id          String   @id @default(cuid())
  storeId     String
  productId   String
  variantId   String?
  stockLotId  String?
  type        StockMovementType
  qtyDelta    Int
  referenceType String?
  referenceId   String?
  note        String?
  createdAt   DateTime @default(now())
  createdById String?

  store   Store   @relation(fields: [storeId], references: [id])
  product Product @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])
  createdBy User? @relation(fields: [createdById], references: [id])
  stockLot StockLot? @relation(fields: [stockLotId], references: [id])

  @@index([storeId, productId, variantId, createdAt])
  @@index([type, createdAt])
}

model PurchaseOrder {
  id             String   @id @default(cuid())
  organizationId String
  storeId        String
  supplierId     String?
  status         PurchaseOrderStatus @default(DRAFT)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  submittedAt    DateTime?
  approvedAt     DateTime?
  receivedAt     DateTime?
  receivedEventId String? @unique
  createdById    String?
  updatedById    String?

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  supplier     Supplier? @relation(fields: [supplierId], references: [id])
  lines        PurchaseOrderLine[]
  createdBy    User? @relation("purchaseOrdersCreated", fields: [createdById], references: [id])
  updatedBy    User? @relation("purchaseOrdersUpdated", fields: [updatedById], references: [id])

  @@index([status, createdAt])
  @@index([storeId])
  @@index([organizationId, createdAt])
  @@index([organizationId, status, createdAt])
}

model PurchaseOrderLine {
  id              String   @id @default(cuid())
  purchaseOrderId String
  productId       String
  variantId       String?
  variantKey      String   @default("BASE")
  qtyOrdered      Int
  qtyReceived     Int @default(0)
  unitCost        Decimal? @db.Decimal(12, 2)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  product       Product @relation(fields: [productId], references: [id])
  variant       ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([purchaseOrderId, productId, variantKey])
  @@index([purchaseOrderId])
  @@index([productId])
  @@index([productId, variantId])
}

model CustomerOrder {
  id               String              @id @default(cuid())
  organizationId   String
  storeId          String
  registerId       String?
  shiftId          String?
  number           String
  status           CustomerOrderStatus @default(DRAFT)
  isPosSale        Boolean             @default(false)
  customerName     String?
  customerPhone    String?
  subtotalKgs      Decimal             @default(0) @db.Decimal(12, 2)
  totalKgs         Decimal             @default(0) @db.Decimal(12, 2)
  notes            String?
  kkmStatus        PosKkmStatus        @default(NOT_SENT)
  kkmReceiptId     String?
  kkmRawJson       Json?
  confirmedAt      DateTime?
  readyAt          DateTime?
  completedAt      DateTime?
  canceledAt       DateTime?
  completedEventId String?             @unique
  createdById      String?
  updatedById      String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  organization Organization         @relation(fields: [organizationId], references: [id])
  store        Store                @relation(fields: [storeId], references: [id])
  register     PosRegister?         @relation(fields: [registerId], references: [id])
  shift        RegisterShift?       @relation(fields: [shiftId], references: [id])
  lines        CustomerOrderLine[]
  payments     SalePayment[]
  saleReturns  SaleReturn[]         @relation("saleReturnsOriginal")
  fiscalReceipts FiscalReceipt[]
  refundRequests RefundRequest[]
  markingCodeCaptures MarkingCodeCapture[]
  createdBy    User?                @relation("customerOrdersCreated", fields: [createdById], references: [id])
  updatedBy    User?                @relation("customerOrdersUpdated", fields: [updatedById], references: [id])

  @@unique([organizationId, number])
  @@index([storeId, status, createdAt])
  @@index([organizationId, status, createdAt])
  @@index([organizationId, createdAt])
  @@index([organizationId, isPosSale, createdAt])
  @@index([shiftId, status, createdAt])
}

model CustomerOrderLine {
  id              String    @id @default(cuid())
  customerOrderId String
  productId       String
  variantId       String?
  variantKey      String    @default("BASE")
  qty             Int
  unitPriceKgs    Decimal   @db.Decimal(12, 2)
  lineTotalKgs    Decimal   @db.Decimal(12, 2)
  unitCostKgs     Decimal?  @db.Decimal(12, 2)
  lineCostTotalKgs Decimal? @db.Decimal(12, 2)

  customerOrder CustomerOrder  @relation(fields: [customerOrderId], references: [id], onDelete: Cascade)
  product       Product        @relation(fields: [productId], references: [id])
  variant       ProductVariant? @relation(fields: [variantId], references: [id])
  saleReturnLines SaleReturnLine[]
  markingCodeCaptures MarkingCodeCapture[]

  @@unique([customerOrderId, productId, variantKey])
  @@index([customerOrderId])
  @@index([productId])
  @@index([productId, variantId])
}

model PosRegister {
  id             String   @id @default(cuid())
  organizationId String
  storeId        String
  name           String
  code           String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  shifts       RegisterShift[]
  sales        CustomerOrder[]
  saleReturns  SaleReturn[]

  @@unique([storeId, code])
  @@index([organizationId, storeId, isActive])
}

model RegisterShift {
  id                    String              @id @default(cuid())
  organizationId        String
  storeId               String
  registerId            String
  status                RegisterShiftStatus @default(OPEN)
  openedAt              DateTime            @default(now())
  openedById            String
  closedAt              DateTime?
  closedById            String?
  openingCashKgs        Decimal             @default(0) @db.Decimal(12, 2)
  closingCashCountedKgs Decimal?            @db.Decimal(12, 2)
  expectedCashKgs       Decimal?            @db.Decimal(12, 2)
  notes                 String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  organization  Organization @relation(fields: [organizationId], references: [id])
  store         Store @relation(fields: [storeId], references: [id])
  register      PosRegister @relation(fields: [registerId], references: [id])
  openedBy      User @relation("posShiftsOpened", fields: [openedById], references: [id])
  closedBy      User? @relation("posShiftsClosed", fields: [closedById], references: [id])
  sales         CustomerOrder[]
  payments      SalePayment[]
  cashMovements CashDrawerMovement[]
  returns       SaleReturn[]

  @@index([organizationId, storeId, status, openedAt])
  @@index([registerId, status, openedAt])
}

model SalePayment {
  id              String           @id @default(cuid())
  organizationId  String
  storeId         String
  shiftId         String
  customerOrderId String
  saleReturnId    String?
  method          PosPaymentMethod
  amountKgs       Decimal          @db.Decimal(12, 2)
  providerRef     String?
  isRefund        Boolean          @default(false)
  createdAt       DateTime         @default(now())
  createdById     String?

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  shift        RegisterShift @relation(fields: [shiftId], references: [id])
  customerOrder CustomerOrder @relation(fields: [customerOrderId], references: [id], onDelete: Cascade)
  saleReturn   SaleReturn? @relation(fields: [saleReturnId], references: [id])
  createdBy    User? @relation("salePaymentsCreated", fields: [createdById], references: [id])

  @@index([organizationId, storeId, createdAt])
  @@index([shiftId, createdAt])
  @@index([customerOrderId, createdAt])
}

model CashDrawerMovement {
  id             String                 @id @default(cuid())
  organizationId String
  storeId        String
  shiftId        String
  type           CashDrawerMovementType
  amountKgs      Decimal                @db.Decimal(12, 2)
  reason         String
  createdAt      DateTime               @default(now())
  createdById    String?

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  shift        RegisterShift @relation(fields: [shiftId], references: [id])
  createdBy    User? @relation("cashDrawerMovementsCreated", fields: [createdById], references: [id])

  @@index([organizationId, storeId, createdAt])
  @@index([shiftId, createdAt])
}

model SaleReturn {
  id               String          @id @default(cuid())
  organizationId   String
  storeId          String
  registerId       String
  shiftId          String
  originalSaleId   String
  number           String
  status           PosReturnStatus @default(DRAFT)
  subtotalKgs      Decimal         @default(0) @db.Decimal(12, 2)
  totalKgs         Decimal         @default(0) @db.Decimal(12, 2)
  notes            String?
  completedAt      DateTime?
  canceledAt       DateTime?
  completedEventId String?         @unique
  createdById      String
  completedById    String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  register     PosRegister @relation(fields: [registerId], references: [id])
  shift        RegisterShift @relation(fields: [shiftId], references: [id])
  originalSale CustomerOrder @relation("saleReturnsOriginal", fields: [originalSaleId], references: [id])
  lines        SaleReturnLine[]
  payments     SalePayment[]
  refundRequests RefundRequest[]
  createdBy    User @relation("saleReturnsCreated", fields: [createdById], references: [id])
  completedBy  User? @relation("saleReturnsCompleted", fields: [completedById], references: [id])

  @@unique([organizationId, number])
  @@index([organizationId, storeId, status, createdAt])
  @@index([originalSaleId, createdAt])
}

model SaleReturnLine {
  id                  String    @id @default(cuid())
  saleReturnId        String
  customerOrderLineId String
  productId           String
  variantId           String?
  variantKey          String    @default("BASE")
  qty                 Int
  unitPriceKgs        Decimal   @db.Decimal(12, 2)
  lineTotalKgs        Decimal   @db.Decimal(12, 2)
  unitCostKgs         Decimal?  @db.Decimal(12, 2)
  lineCostTotalKgs    Decimal?  @db.Decimal(12, 2)

  saleReturn      SaleReturn @relation(fields: [saleReturnId], references: [id], onDelete: Cascade)
  customerOrderLine CustomerOrderLine @relation(fields: [customerOrderLineId], references: [id])
  product         Product @relation(fields: [productId], references: [id])
  variant         ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([saleReturnId, customerOrderLineId])
  @@index([saleReturnId])
  @@index([productId, variantId])
}

model FiscalReceipt {
  id               String              @id @default(cuid())
  organizationId   String
  storeId          String
  customerOrderId  String
  status           FiscalReceiptStatus @default(QUEUED)
  mode             KkmMode             @default(EXPORT_ONLY)
  providerKey      String?
  idempotencyKey   String              @unique
  payloadJson      Json
  attemptCount     Int                 @default(0)
  lastError        String?
  nextAttemptAt    DateTime?
  providerReceiptId String?
  fiscalNumber     String?
  qr               String?
  connectorDeviceId String?
  sentAt           DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  customerOrder CustomerOrder @relation(fields: [customerOrderId], references: [id], onDelete: Cascade)
  connectorDevice KkmConnectorDevice? @relation(fields: [connectorDeviceId], references: [id])

  @@index([organizationId, storeId, status, createdAt])
  @@index([storeId, status, createdAt])
  @@index([connectorDeviceId, status, createdAt])
}

model KkmConnectorDevice {
  id             String   @id @default(cuid())
  organizationId String
  storeId        String
  name           String
  tokenHash      String   @unique
  isActive       Boolean  @default(true)
  pairedAt       DateTime @default(now())
  lastSeenAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  fiscalReceipts FiscalReceipt[]

  @@index([organizationId, storeId, isActive])
}

model KkmConnectorPairingCode {
  id             String   @id @default(cuid())
  organizationId String
  storeId        String
  code           String   @unique
  expiresAt      DateTime
  consumedAt     DateTime?
  createdById    String
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  createdBy    User @relation("kkmPairingCodeCreatedBy", fields: [createdById], references: [id])

  @@index([organizationId, storeId, expiresAt])
}

model RefundRequest {
  id               String              @id @default(cuid())
  organizationId   String
  storeId          String
  saleReturnId     String              @unique
  originalSaleId   String
  status           RefundRequestStatus @default(OPEN)
  paymentMethod    PosPaymentMethod
  reasonCode       String
  notes            String?
  createdById      String
  reviewedById     String?
  reviewedAt       DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  saleReturn   SaleReturn @relation(fields: [saleReturnId], references: [id], onDelete: Cascade)
  originalSale CustomerOrder @relation(fields: [originalSaleId], references: [id], onDelete: Cascade)
  createdBy    User @relation("refundRequestsCreatedBy", fields: [createdById], references: [id])
  reviewedBy   User? @relation("refundRequestsReviewedBy", fields: [reviewedById], references: [id])

  @@index([organizationId, storeId, status, createdAt])
  @@index([saleReturnId])
  @@index([originalSaleId])
}

model MarkingCodeCapture {
  id              String            @id @default(cuid())
  organizationId  String
  storeId         String
  saleId          String
  saleLineId      String
  code            String
  status          MarkingCodeStatus @default(CAPTURED)
  capturedAt      DateTime          @default(now())
  capturedById    String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  sale         CustomerOrder @relation(fields: [saleId], references: [id], onDelete: Cascade)
  saleLine     CustomerOrderLine @relation(fields: [saleLineId], references: [id], onDelete: Cascade)
  capturedBy   User? @relation("markingCapturedBy", fields: [capturedById], references: [id])

  @@unique([saleLineId, code])
  @@index([organizationId, storeId, capturedAt])
  @@index([saleId, saleLineId, status])
}

model EttnReference {
  id             String                   @id @default(cuid())
  organizationId String
  storeId        String
  documentType   TaxReferenceDocumentType
  documentId     String
  ettnNumber     String
  ettnDate       DateTime?
  notes          String?
  createdById    String?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  createdBy    User? @relation("ettnReferenceCreatedBy", fields: [createdById], references: [id])

  @@unique([organizationId, storeId, documentType, documentId])
  @@index([organizationId, storeId, documentType, createdAt])
  @@index([documentType, documentId])
}

model EsfReference {
  id               String                   @id @default(cuid())
  organizationId   String
  storeId          String
  documentType     TaxReferenceDocumentType
  documentId       String
  esfNumber        String
  esfDate          DateTime?
  counterpartyName String?
  createdById      String?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  createdBy    User? @relation("esfReferenceCreatedBy", fields: [createdById], references: [id])

  @@unique([organizationId, storeId, documentType, documentId])
  @@index([organizationId, storeId, documentType, createdAt])
  @@index([documentType, documentId])
}

model ReorderPolicy {
  id               String   @id @default(cuid())
  storeId          String
  productId        String
  minStock         Int      @default(0)
  leadTimeDays     Int
  reviewPeriodDays Int
  safetyStockDays  Int
  minOrderQty      Int @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  store   Store   @relation(fields: [storeId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@unique([storeId, productId])
  @@index([storeId, productId])
}

model ForecastSnapshot {
  id           String   @id @default(cuid())
  storeId      String
  productId    String
  p50Daily     Float
  p90Daily     Float
  horizonDays  Int
  generatedAt  DateTime @default(now())

  store   Store   @relation(fields: [storeId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@index([storeId, productId, generatedAt])
}

model AuditLog {
  id             String   @id @default(cuid())
  organizationId String
  actorId        String?
  action         String
  entity         String
  entityId       String
  before         Json?
  after          Json?
  requestId      String
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  actor        User? @relation(fields: [actorId], references: [id])

  @@index([createdAt])
  @@index([entity, entityId])
}

model IdempotencyKey {
  id         String   @id @default(cuid())
  key        String
  route      String
  userId     String
  response   Json?
  responseHash String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@unique([key, route, userId])
  @@index([createdAt])
}

model StockCount {
  id             String   @id @default(cuid())
  organizationId String
  storeId        String
  code           String
  status         StockCountStatus @default(DRAFT)
  notes          String? @db.Text
  startedAt      DateTime?
  appliedAt      DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdById    String?
  appliedById    String?

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  createdBy    User? @relation("stockCountCreatedBy", fields: [createdById], references: [id])
  appliedBy    User? @relation("stockCountAppliedBy", fields: [appliedById], references: [id])
  lines        StockCountLine[]

  @@unique([organizationId, code])
  @@index([storeId, status, createdAt])
  @@index([organizationId])
}

model StockCountLine {
  id              String   @id @default(cuid())
  stockCountId    String
  storeId         String
  productId       String
  variantId       String?
  variantKey      String   @default("BASE")
  barcodeValue    String?
  expectedOnHand  Int      @default(0)
  countedQty      Int      @default(0)
  deltaQty        Int      @default(0)
  lastScannedAt   DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  stockCount StockCount @relation(fields: [stockCountId], references: [id])
  store      Store @relation(fields: [storeId], references: [id])
  product    Product @relation(fields: [productId], references: [id])
  variant    ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([stockCountId, productId, variantKey])
  @@index([storeId, productId])
}

model StorePrice {
  id             String   @id @default(cuid())
  organizationId String
  storeId        String
  productId      String
  variantId      String?
  variantKey     String   @default("BASE")
  priceKgs       Decimal  @db.Decimal(12, 2)
  updatedAt      DateTime @updatedAt
  updatedById    String?

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  product      Product @relation(fields: [productId], references: [id])
  variant      ProductVariant? @relation(fields: [variantId], references: [id])
  updatedBy    User? @relation("storePricesUpdated", fields: [updatedById], references: [id])

  @@unique([organizationId, storeId, productId, variantKey])
  @@index([storeId, productId])
  @@index([organizationId])
}

model ProductCost {
  id             String   @id @default(cuid())
  organizationId String
  productId      String
  variantId      String?
  variantKey     String   @default("BASE")
  avgCostKgs     Decimal  @db.Decimal(12, 2)
  costBasisQty   Int      @default(0)
  lastReceiptAt  DateTime?
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  product      Product @relation(fields: [productId], references: [id])
  variant      ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([organizationId, productId, variantKey])
  @@index([productId])
}

model ProductBundleComponent {
  id                  String   @id @default(cuid())
  organizationId      String
  bundleProductId     String
  componentProductId  String
  componentVariantId  String?
  qty                 Int
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  organization     Organization @relation(fields: [organizationId], references: [id])
  bundleProduct    Product @relation("bundleComponents", fields: [bundleProductId], references: [id])
  componentProduct Product @relation("bundleParents", fields: [componentProductId], references: [id])
  componentVariant ProductVariant? @relation("bundleComponentVariants", fields: [componentVariantId], references: [id])

  @@unique([bundleProductId, componentProductId, componentVariantId])
  @@index([bundleProductId])
}

model StockLot {
  id             String   @id @default(cuid())
  organizationId String
  storeId        String
  productId      String
  variantId      String?
  variantKey     String   @default("BASE")
  expiryDate     DateTime?
  receivedAt     DateTime @default(now())
  onHandQty      Int      @default(0)
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  store        Store @relation(fields: [storeId], references: [id])
  product      Product @relation(fields: [productId], references: [id])
  variant      ProductVariant? @relation(fields: [variantId], references: [id])
  movements    StockMovement[]

  @@index([storeId, productId, variantKey, expiryDate])
}

model AttributeDefinition {
  id             String   @id @default(cuid())
  organizationId String
  key            String
  labelRu        String
  labelKg        String
  type           AttributeType
  optionsRu      Json?
  optionsKg      Json?
  required       Boolean  @default(false)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  values       VariantAttributeValue[]
  templates    CategoryAttributeTemplate[]

  @@unique([organizationId, key])
  @@index([organizationId])
}

model CategoryAttributeTemplate {
  id             String   @id @default(cuid())
  organizationId String
  category       String
  attributeKey   String
  order          Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  definition   AttributeDefinition? @relation(fields: [organizationId, attributeKey], references: [organizationId, key])

  @@unique([organizationId, category, attributeKey])
  @@index([organizationId, category])
}

model VariantAttributeValue {
  id             String   @id @default(cuid())
  organizationId String
  productId      String
  variantId      String
  key            String
  value          Json
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  product      Product @relation(fields: [productId], references: [id])
  variant      ProductVariant @relation(fields: [variantId], references: [id])
  definition   AttributeDefinition? @relation(fields: [organizationId, key], references: [organizationId, key])

  @@unique([variantId, key])
  @@index([productId])
}

model ImportBatch {
  id             String   @id @default(cuid())
  organizationId String
  type           String
  createdById    String?
  createdAt      DateTime @default(now())
  summary        Json?
  rolledBackAt   DateTime?
  rolledBackById String?

  organization Organization @relation(fields: [organizationId], references: [id])
  createdBy    User? @relation("importBatchesCreated", fields: [createdById], references: [id])
  rolledBackBy User? @relation("importBatchesRolledBack", fields: [rolledBackById], references: [id])
  entities     ImportedEntity[]
  rollbackReport ImportRollbackReport?

  @@index([organizationId, createdAt])
}

model ImportedEntity {
  id         String   @id @default(cuid())
  batchId    String
  entityType String
  entityId   String
  createdAt  DateTime @default(now())

  batch ImportBatch @relation(fields: [batchId], references: [id])

  @@unique([batchId, entityType, entityId])
  @@index([entityType, entityId])
}

model ImportRollbackReport {
  id          String   @id @default(cuid())
  batchId     String   @unique
  createdById String?
  createdAt   DateTime @default(now())
  summary     Json?

  batch     ImportBatch @relation(fields: [batchId], references: [id])
  createdBy User? @relation("importRollbackReportsCreated", fields: [createdById], references: [id])
}

model OnboardingProgress {
  id             String   @id @default(cuid())
  organizationId String   @unique
  steps          Json
  completedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
}

model DeadLetterJob {
  id            String   @id @default(cuid())
  organizationId String?
  jobName       String
  payload       Json?
  attempts      Int      @default(0)
  lastError     String
  lastErrorAt   DateTime @default(now())
  resolvedAt    DateTime?
  resolvedById  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id])
  resolvedBy User? @relation("deadLetterResolvedBy", fields: [resolvedById], references: [id])

  @@index([jobName, lastErrorAt])
  @@index([resolvedAt])
}

model StoreFeatureFlag {
  id            String   @id @default(cuid())
  storeId       String
  key           String
  enabled       Boolean  @default(false)
  updatedById   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  store     Store  @relation(fields: [storeId], references: [id])
  updatedBy User?  @relation(fields: [updatedById], references: [id])

  @@unique([storeId, key])
  @@index([storeId])
}

model ProductEvent {
  id             String   @id @default(cuid())
  organizationId String
  type           String
  actorId        String?
  metadata       Json?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  actor        User? @relation("productEventsCreatedBy", fields: [actorId], references: [id])

  @@index([organizationId, type, createdAt])
}

model ImpersonationSession {
  id             String   @id @default(cuid())
  organizationId String
  createdById    String
  targetUserId   String
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  revokedAt      DateTime?

  organization Organization @relation(fields: [organizationId], references: [id])
  createdBy    User @relation("impersonationsCreated", fields: [createdById], references: [id])
  targetUser   User @relation("impersonationsTargeted", fields: [targetUserId], references: [id])

  @@index([organizationId, createdAt])
  @@index([targetUserId])
  @@index([expiresAt])
}

model InviteToken {
  id             String   @id @default(cuid())
  organizationId String
  email          String
  role           Role
  tokenHash      String   @unique
  expiresAt      DateTime
  createdById    String
  acceptedAt     DateTime?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  createdBy    User @relation("inviteCreatedBy", fields: [createdById], references: [id])

  @@index([organizationId, email])
}

model AccessRequest {
  id        String   @id @default(cuid())
  organizationId String?
  email     String
  orgName   String?
  createdAt DateTime @default(now())

  organization Organization? @relation(fields: [organizationId], references: [id])

  @@index([email])
}

model AuthToken {
  id        String   @id @default(cuid())
  userId    String?
  email     String
  type      AuthTokenType
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([email, type])
}
