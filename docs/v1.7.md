# V1.7 â€” Kyrgyzstan Compliance Pack

## Scope
- Per-store KG compliance profile with progressive disclosure.
- Accountant-friendly exports + export jobs.
- Period close summary for accounting trust (non-blocking).
- KKM adapter interface (stub + export-only mode).

## Compliance modules & toggles
- KKM
  - `kkmMode`: `OFF` | `EXPORT_ONLY` | `ADAPTER`
- ESF
- ETTN
- Marking

## Data model additions
- `StoreComplianceProfile`
  - `organizationId`, `storeId` (unique)
  - `defaultLocale`, `taxRegime`
  - `enableKkm`, `kkmMode`, `kkmProviderKey`, `kkmSettings`
  - `enableEsf`, `enableEttn`, `enableMarking`
  - `updatedById`, timestamps
- `ProductComplianceFlags` (optional per product)
  - `requiresMarking`, `requiresEttn`, `markingType`
- `ExportJob`
  - `type`, `status`, `periodStart`, `periodEnd`, `requestedById`
  - `fileName`, `mimeType`, `fileSize`, `storagePath`, `errorMessage`
- `PeriodClose`
  - `periodStart`, `periodEnd`, `closedAt`, `closedById`, `totals`

## Permissions
- ADMIN
  - edit compliance settings
  - create exports
  - close period
- MANAGER
  - view compliance settings
  - create exports
  - close period
- STAFF
  - no compliance edit access
  - no period close

## Export formats (CSV)
- SALES_SUMMARY
  - date, store, totalQty, movementCount
- STOCK_MOVEMENTS
  - date, store, sku, product, variant, movementType, qtyDelta, reference, actor
- PURCHASES
  - poId, status, createdAt, receivedAt, store, supplier, sku, product, variant, qtyOrdered, qtyReceived, unitCostKgs, lineTotalKgs
- INVENTORY_ON_HAND
  - store, sku, product, variant, onHand, onOrder, minStock, reorderPoint, effectivePriceKgs
- PERIOD_CLOSE_REPORT
  - store, periodStart, periodEnd, closedAt, movementCount, skuCount, salesTotalKgs, purchasesTotalKgs
- RECEIPTS_FOR_KKM
  - receiptId, date, store, sku, product, variant, qty

If marking/ETTN are enabled, exports append `markingRequired`, `markingType`, `ettnRequired` columns where applicable.

## KKM adapter interface
- `src/server/kkm/adapter.ts`
  - `KkmAdapter.health()`
  - `KkmAdapter.fiscalizeReceipt()`
- `src/server/kkm/registry.ts`
  - provider registry with default stub

## Test plan
- Period close cannot be duplicated for the same month.
- Export-only receipts CSV headers are stable.
- KKM registry returns stub adapter and throws on fiscalize.

## Manual smoke checklist
- Enable compliance modules for a store; verify badge and advanced panel.
- Generate each export type and download the CSV.
- Create a period close and verify duplicates are blocked.
- Verify RBAC: STAFF cannot edit compliance or close a period.
- Switch RU/KG and verify compliance copy updates.
