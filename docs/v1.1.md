# V1.1 Plan

Date: 2026-01-26

## Scope summary
- Stock counts (revisions) with scan-first workflow and idempotent apply.
- Store-specific pricing with bulk updates and effective price resolution.
- Avg cost + margin/markup panel on product.
- Price tags PDF (two templates) with print dialog.
- Bundles (kits/sets) + expiry lots (gated by store setting).
- Variant attribute definitions + non-technical editor.

## Data model changes
- Product: add `basePriceKgs` (Decimal) for default pricing.
- Store: add `trackExpiryLots` (Boolean, default false).
- StorePrice: store/product/variant price override.
- ProductCost: weighted avg cost aggregate per product/variant.
- StockCount + StockCountLine: inventory revision documents.
- ProductBundleComponent: kit composition lines.
- StockLot: per-store expiry lot tracking.
- AttributeDefinition + VariantAttributeValue: attribute definitions and values.
- StockMovement: optional `stockLotId` for lot-specific adjustments (when tracked).

## UX flows (high level)
### Stock counts
- Inventory list links to `/inventory/counts`.
- Create count -> redirect to detail `/inventory/counts/[id]`.
- Persistent scan input; Enter adds/increments line. Counted qty editable per line.
- Summary card shows totals and variance.
- Apply: managers/admins only, idempotent adjustment with confirmation.
- Report view on applied counts (overages/shortages + optional CSV).

### Store pricing
- Products list shows base and effective price when a store is selected.
- Row action "Set store price" for per-item override.
- Bulk update dialog: store + filter + mode (set/percent/absolute) + preview.

### Avg cost + margin/markup
- Product detail shows Profitability panel:
  - Base price, effective price (if store selected)
  - Avg cost
  - Markup % and Margin % with helper text

### Price tags PDF
- Products list multi-select -> "Print price tags" dialog.
- Choose template and store; set quantity per item.
- PDF download from API route.

### Bundles
- Product detail includes collapsed Bundle section when product is a bundle or has components.
- Manage components (add/remove) with product/variant picker.
- Assemble action creates paired movements in one transaction (idempotent).

### Expiry lots
- Store setting enables lot tracking.
- Inventory receive allows optional expiry date; creates/updates lot.
- Adjust/transfer optionally target a specific lot; otherwise adjust "unknown lot".
- Inventory shows expiring soon panel when enabled.
- Product detail shows lots for selected store behind a toggle.

### Variant attributes
- Settings > Attributes (admin only) to manage definitions.
- Product variant editor uses definitions to render friendly inputs.
- Required attributes enforced; raw JSON not exposed in UI.

## Permissions matrix
- Staff: run stock counts, edit counted qty, cannot apply/cancel; view store pricing; no bulk update.
- Manager/Admin: apply/cancel counts, bulk price update, bundle assembly, attribute CRUD (admin only).
- Admin only: attribute definitions management, user management, product creation/role changes.

## Test plan
- Stock counts: create + scan increments; apply creates adjustments (idempotent); RBAC apply.
- StorePrice: effective price resolution; bulk update by mode; RBAC bulk update.
- ProductCost: weighted avg update on receipt; margin/markup calc.
- Price tags: API returns PDF + validates template selection.
- Bundles: assemble creates consume/receive movements and is idempotent.
- Expiry lots: receive creates lot; expiring soon query; unchanged behavior when disabled.
- Attributes: definition CRUD RBAC; variant save validates required attributes.

## Manual smoke checklist
- Run stock count with scanner; apply and verify movements.
- Set store price; bulk update; verify effective price badge.
- View profitability panel values.
- Print price tags PDF (both templates).
- Assemble bundle and verify inventory deltas.
- Enable expiry lots for a store; receive with expiry; verify expiring soon panel.
- Create attribute definitions and apply to variant.
