# V1.6 — Self‑Signup + Tenant Creation + Invites + Trial/Plans + Tenant Isolation Tests

## Scope
Enable safe self-registration for new tenants with email verification, invite-only mode, and trial plan limits. Add invite flows for admins and tests proving tenant isolation.

## Signup Modes
- `SIGNUP_MODE=invite_only` (default)
  - `/signup` shows “Request access”.
  - Only `/invite/[token]` completes onboarding.
- `SIGNUP_MODE=open`
  - `/signup` stepper creates Org + Store + Admin user.

## Data Model Changes
- `Organization.plan` (TRIAL | PRO), `Organization.trialEndsAt`
- `User.emailVerifiedAt`
- `InviteToken` (orgId, email, role, tokenHash, expiresAt, createdById, acceptedAt)
- `AuthToken` (email, type=EMAIL_VERIFY|PASSWORD_RESET, tokenHash, expiresAt, usedAt)
- `AccessRequest` (email, orgName, createdAt)

## Flows
### Self‑Signup (open mode)
1. `/signup` → account + org/store stepper.
2. Create Org + Store + Admin user in one transaction.
3. Send email verification link.
4. Redirect to `/verify/[token]` and then `/login`.

### Invite‑Only
1. Admin creates invite on `/settings/users`.
2. Invite link shared with user: `/invite/[token]`.
3. Invite accepted → user created with org role.

### Email Verification + Password Reset
- Verification link required before login.
- `/reset` requests reset; `/reset/[token]` sets new password.

### Trial & Plans
- Trial defaults to 14 days on org creation.
- Mutations blocked if trial expired (read-only still allowed).
- Hard limits enforced on store/user/product creation.

## Security & Guardrails
- Public endpoints rate-limited.
- Token hashes stored (raw token never stored).
- Invites one-time use, time-bound.
- Org creation limited by unique email.
- All admin actions audited.

## Permissions
- ADMIN: invite users, manage roles, billing view.
- MANAGER/STAFF: no invite or billing access.

## Tests
- Signup creates org/store/admin and blocks duplicate signup for same email.
- Invite token acceptance creates user in the correct org.
- Tenant isolation prevents cross-org access for products/stores/inventory/POs.

## QA Checklist
- `invite_only` → request access shown; invite link works.
- `open` → signup completes, verification required, login blocked until verified.
- Admin invite generates link and creates user.
- Trial expiry blocks mutations with localized error.
- Billing page shows trial status and limits.
- i18n keys present in ru/kg.
