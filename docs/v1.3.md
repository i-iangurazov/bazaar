# V1.3 — Universal Retail Core

## Scope
- Units of Measure (UoM) + product packaging conversions.
- Human-friendly attribute templates + variant generator.
- Migration importers (CloudShop Excel + 1C-friendly CSV).
- Operational analytics reports (stockouts, slow movers, shrinkage).

## Data Model Changes
- `Unit` (org-scoped): code, labelRu/labelKg.
- `Product.baseUnitId` (required).
- `ProductPack` (optional conversions per product).
- `CategoryAttributeTemplate` (attribute templates by category key).
- No ledger changes: `StockMovement.qtyDelta` remains in base unit only.

## Key Flows
### UoM + Packaging
- Product selects base unit (e.g., шт, кг, л, м).
- Product packs define multipliers (e.g., box = 12 шт).
- Receiving/adjust/transfer/PO lines accept qty + unit selector.
- UI shows base-unit conversion as helper text; ledger writes base qty only.

### Attribute Templates + Variant Generator
- Admin defines attribute definitions (/settings/attributes).
- Category template assigns attributes to category key (product.category).
- Product variants: “Generate variants” wizard builds matrix from attributes.
- Variant editor shows friendly chips/inputs (no raw JSON).

### Migration Importers
- /settings/import: upload → preview → mapping → validate → apply.
- CloudShop Excel detection (column heuristics) and generic CSV support.
- 1C CSV template download from the UI (localized headers + example row).
- Validation error CSV download; invalid rows are skipped.
- Idempotent upsert by SKU; barcode uniqueness enforced server-side.

### Operational Analytics
- /reports: Stockouts, Slow movers, Shrinkage.
- Filters: store + date range.
- CSV export for each report.

## Permissions
- UoM and Packs: ADMIN/MANAGER.
- Attribute definitions + templates: ADMIN.
- Variant generator: ADMIN/MANAGER.
- Importers: ADMIN.
- Reports: ADMIN/MANAGER (read-only).

## Tests
- UoM conversion correctness for receive/adjust/transfer/PO receive.
- Variant generator persists correct attribute values.
- Importers validate + apply correctly (idempotent).
- Reports query deterministic output for known dataset.
  - `tests/unit/variant-generator.test.ts`
  - `tests/integration/reports.test.ts`

## QA Checklist
- Unit selection + conversion helper text.
- Pack barcode optional and doesn’t break scan/search.
- Variant generator produces expected matrix.
- Importer preview + error CSV.
- Reports show expected counts and export CSV.
