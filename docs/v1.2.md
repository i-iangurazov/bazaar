# V1.2 — Production Hardening & Procurement Workflows

## Scope
- Redis-backed event bus for multi-instance real-time updates (SSE).
- Redis-backed rate limiting for auth + high-frequency mutations.
- Job runner endpoint with distributed lock.
- Partial purchase order receipts with idempotency and status transitions.
- Replenishment suggestions → create PO drafts grouped by supplier.

## Data Model Changes
- `PurchaseOrderStatus`: add `PARTIALLY_RECEIVED`.
- No new tables required for partial receipts (uses `qtyOrdered`/`qtyReceived`).
- Redis configuration (no DB schema change).

## Key Flows
### Real-time (SSE)
- Publish events via Redis channel when configured.
- SSE endpoint subscribes to Redis and forwards events.
- In dev without Redis, fallback to in-memory bus with warning.

### Partial PO Receipts
- Receive dialog allows entering received qty per line.
- Creates RECEIVE movements per received qty.
- Updates `qtyReceived` per line and PO status:
  - `APPROVED` → `PARTIALLY_RECEIVED` → `RECEIVED`.
- Idempotent by receipt event key.
- Over-receive blocked by default; optional allow-over-receive toggle.

### Replenishment → PO Drafts
- From inventory low-stock list, create draft POs grouped by supplier.
- Missing supplier prompts user to assign supplier per item before creating.
- Drafts remain editable before submit/approve.

## Permissions
- Redis SSE: no special permission (existing auth/session gates).
- Rate limiting: all users on high-frequency mutations.
- PO receive and create draft: MANAGER/ADMIN only.

## Tests
- Partial receipts update `qtyReceived` and status correctly.
- Idempotent receive events do not duplicate movements.
- Over-receive blocked by default.
- Draft PO creation grouped by supplier.
- Rate limiter does not block normal usage.

## QA Checklist
- SSE updates across tabs and instances (Redis enabled).
- Partial receive works and status updates.
- Over-receive toggle enforces rules.
- Create PO drafts from low-stock suggestions.
- i18n ru/kg coverage for all new labels/errors.
